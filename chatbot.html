<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Asistente IA - Editor de Imágenes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #0d1117;
      --bg-med: #161b22;
      --panel: #21262d;
      --border: #30363d;
      --text-main: #c9d1d9;
      --text-muted: #8b949e;
      --accent: #58a6ff;
      --accent-hover: #79c0ff;
      --accent-text: #0d1117;
      --glass: rgba(56, 139, 253, 0.07);
      --shadow: 0 8px 24px rgba(0,0,0,0.4);
      --radius-sm: 6px;
      --radius-md: 10px;
      --transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-main);
      font-size: 14px;
      line-height: 1.5;
      padding: 20px;
    }
    .page-header { 
      padding: 20px 24px; 
      background: linear-gradient(135deg, var(--bg-med), var(--panel)); 
      border-bottom: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 20px;
    }
    h1 { 
      margin: 0; 
      font-size: 1.75rem; 
      font-weight: 700; 
      letter-spacing: -0.8px; 
      background: linear-gradient(135deg, var(--accent), var(--accent-hover)); 
      background-clip: text;
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent; 
    }
    .chatbot-container {
      max-width: 800px;
      margin: 0 auto;
      background: linear-gradient(145deg, var(--bg-med), var(--panel));
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .section-header { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      margin-bottom: 20px; 
      padding-bottom: 12px; 
      border-bottom: 1px solid var(--border); 
    }
    .section-icon { width: 20px; height: 20px; color: var(--accent); }
    h2 { font-size: 1.2rem; margin: 0; font-weight: 600; color: var(--text-main); }
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      background: var(--accent); border: 1px solid var(--accent); padding: 8px 16px;
      border-radius: var(--radius-sm); color: var(--accent-text); font-weight: 500;
      cursor: pointer; text-align: center; white-space: nowrap; transition: var(--transition);
      font-size: 14px;
    }
    .btn:hover { background: var(--accent-hover); border-color: var(--accent-hover); transform: translateY(-1px); }
    input[type=text] {
      width: 100%; padding: 8px 12px; border-radius: var(--radius-sm); border: 1px solid var(--border);
      background-color: var(--bg-dark); color: var(--text-main); transition: var(--transition);
    }
    input:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 3px var(--glass); }

    /* Estilos del Chatbot */
    .ai-section { background: linear-gradient(135deg, var(--glass), transparent); border-radius: 12px; padding: 16px; }
    #chatContainer { display: flex; flex-direction: column; height: 400px; }
    #chatMessages { 
      flex-grow: 1; overflow-y: auto; padding: 16px; background: var(--bg-dark); 
      border-radius: 12px; border: 1px solid var(--border); display: flex; 
      flex-direction: column; gap: 12px; scrollbar-width: thin; 
    }
    #chatMessages::-webkit-scrollbar { width: 6px; }
    #chatMessages::-webkit-scrollbar-track { background: var(--bg-dark); }
    #chatMessages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    .chat-message { 
      max-width: 85%; padding: 12px 16px; border-radius: 18px; 
      line-height: 1.5; word-wrap: break-word; font-size: 14px; 
    }
    .user-message { 
      background: linear-gradient(135deg, var(--accent), var(--accent-hover)); 
      color: white; align-self: flex-end; border-bottom-right-radius: 4px; 
      box-shadow: 0 2px 8px rgba(88, 166, 255, 0.3); 
    }
    .bot-message { 
      background: var(--panel); color: var(--text-main); align-self: flex-start; 
      border-bottom-left-radius: 4px; border: 1px solid var(--border); 
    }
    .typing-indicator { align-self: flex-start; color: var(--text-muted); padding: 12px 16px; }
    .typing-indicator span { 
      display: inline-block; width: 6px; height: 6px; background-color: var(--accent); 
      border-radius: 50%; margin: 0 2px; animation: bounce 1.4s infinite ease-in-out; 
    }
    .typing-indicator span:nth-child(2) { animation-delay: -0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: -0.4s; }
    @keyframes bounce { 
      0%, 80%, 100% { transform: scale(0); opacity: 0.5; } 
      40% { transform: scale(1.0); opacity: 1; } 
    }
    #chatInputArea { display: flex; gap: 12px; margin-top: 16px; }
    #chatInput { 
      flex: 1; padding: 12px 16px; border-radius: 24px; 
      border: 2px solid var(--border); background: var(--bg-dark); transition: all 0.2s; 
    }
    #chatInput:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--glass); }
    #chatSendBtn { 
      padding: 12px 20px; border-radius: 24px; 
      background: linear-gradient(135deg, var(--accent), var(--accent-hover)); border: none; 
    }
  </style>
</head>

<body>
  <header class="page-header">
    <h1>Asistente IA - Editor de Imágenes</h1>
  </header>

  <div class="chatbot-container">
    <div class="ai-section">
      <div class="section-header">
        <svg class="section-icon" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
        </svg>
        <h2>Asistente IA</h2>
      </div>
      <div id="chatContainer">
        <div id="chatMessages"></div>
        <div id="chatInputArea">
          <input type="text" id="chatInput" placeholder="Describe el estilo que buscas..." />
          <button id="chatSendBtn" class="btn">✨</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Secure API key management
    let GEMINI_API_KEY = null;
    
    // Try to get API key from environment or prompt user
    function getApiKey() {
      if (GEMINI_API_KEY) return GEMINI_API_KEY;
      
      // Try to get from localStorage first
      const storedKey = localStorage.getItem('gemini_api_key');
      if (storedKey) {
        GEMINI_API_KEY = storedKey;
        return GEMINI_API_KEY;
      }
      
      // Prompt user for API key
      const key = prompt('Por favor, ingresa tu API key de Google Gemini:');
      if (key) {
        GEMINI_API_KEY = key;
        localStorage.setItem('gemini_api_key', key);
        return GEMINI_API_KEY;
      }
      
      return null;
    }
    
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const chatSendBtn = document.getElementById('chatSendBtn');
    
    function addMessage(content, isUser = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${isUser ? 'user-message' : 'bot-message'}`;
      messageDiv.textContent = content;
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function showTypingIndicator() {
      const typingDiv = document.createElement('div');
      typingDiv.className = 'typing-indicator';
      typingDiv.innerHTML = '<span></span><span></span><span></span>';
      typingDiv.id = 'typing';
      chatMessages.appendChild(typingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function hideTypingIndicator() {
      const typing = document.getElementById('typing');
      if (typing) typing.remove();
    }
    
    async function sendToGemini(message) {
      const apiKey = getApiKey();
      if (!apiKey) {
        return 'Error: API Key requerida para usar el asistente de IA. Por favor, configura tu API key.';
      }
      
      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            contents: [{
              parts: [{
                text: `Eres un asistente experto en edición de imágenes. Ayuda con técnicas, herramientas y consejos de edición fotográfica. Usuario: ${message}`
              }]
            }]
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          console.error('Error API:', response.status, errorData);
          
          // Handle specific error cases
          if (response.status === 401 || response.status === 403) {
            localStorage.removeItem('gemini_api_key');
            GEMINI_API_KEY = null;
            return 'Error: API Key inválida. Por favor, verifica tu API key.';
          }
          
          if (response.status === 429) {
            return 'Error 429: Has alcanzado el límite de solicitudes. Espera unos minutos antes de intentar nuevamente.';
          }
          
          return `Error ${response.status}: ${errorData.error?.message || 'Error desconocido'}`;
        }
        
        const data = await response.json();
        return data.candidates[0].content.parts[0].text;
      } catch (error) {
        console.error('Error:', error);
        return `Error: ${error.message}`;
      }
    }
    
    // Respuestas simples para conversación básica
    function getSimpleResponse(message) {
      const msg = message.toLowerCase();
      const responses = {
        'hola': '¡Hola! 👋 ¿En qué puedo ayudarte con la edición de tu imagen?',
        'hi': '¡Hi! 👋 How can I help you with image editing?',
        'hello': '¡Hello! 👋 What editing style are you looking for?',
        'buenos días': '¡Buenos días! ☀️ ¿Qué tipo de edición quieres hacer hoy?',
        'buenas tardes': '¡Buenas tardes! 🌅 ¿Cómo puedo ayudarte con tu imagen?',
        'buenas noches': '¡Buenas noches! 🌙 ¿Qué estilo buscas para tu foto?',
        'gracias': '¡De nada! 😊 ¿Hay algo más en lo que pueda ayudarte?',
        'thanks': 'You\'re welcome! 😊 Anything else I can help with?',
        'adiós': '¡Hasta luego! 👋 Que tengas un buen día editando imágenes.',
        'bye': 'Goodbye! 👋 Happy editing!',
        'ayuda': '¡Por supuesto! Puedes pedirme consejos sobre técnicas de edición, ajustes de color, composición, etc. 🎨',
        'help': 'Sure! You can ask me for advice on editing techniques, color adjustments, composition, etc. 🎨',
        '¿qué puedes hacer?': 'Puedo ayudarte con consejos de edición fotográfica, técnicas, herramientas y responder preguntas sobre fotografía. ✨',
        'what can you do': 'I can help you with photo editing advice, techniques, tools and answer photography questions. ✨'
      };
      
      for (const [key, response] of Object.entries(responses)) {
        if (msg.includes(key)) return response;
      }
      return null;
    }

    async function handleSendMessage() {
      const message = chatInput.value.trim();
      if (!message) return;
      
      addMessage(message, true);
      chatInput.value = '';
      
      // Verificar si es una respuesta simple
      const simpleResponse = getSimpleResponse(message);
      if (simpleResponse) {
        showTypingIndicator();
        setTimeout(() => {
          hideTypingIndicator();
          addMessage(simpleResponse);
        }, 800);
        return;
      }
      
      showTypingIndicator();
      
      try {
        const response = await sendToGemini(message);
        hideTypingIndicator();
        addMessage(response);
      } catch (error) {
        hideTypingIndicator();
        addMessage(`Error: ${error.message}`);
      }
    }
    
    chatSendBtn.addEventListener('click', handleSendMessage);
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleSendMessage();
    });
    
    // Mensaje de bienvenida
    addMessage('¡Hola! Soy tu asistente de edición de imágenes. ¿En qué puedo ayudarte hoy?');
  </script>
</body>
</html>